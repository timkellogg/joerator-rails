<% provide(:title, "Coffeeshops") %>

<div class="container content-container">

  <% if @came_from_search %>
    <div class="col-xs-12">
      <button id="toggle-form" class="btn btn-blue">Not Satisfied?</button>
    </div>
    <div id="search-container" class="hidden">    
      <div class="col-md-6">
        <%= form_tag(coffeeshops_path, :method => "get", id: "search-form") do %>
          <div class="input-group">
            <span class="input-group-btn">
              <button type="submit" class="btn btn-gray" type="button"><%= fa_icon "map-marker" %></button>
            </span>
            <%= text_field_tag :search_location, params[:search_location], class: "form-control nudge", placeholder: "Search by location..." %>
          </div>
        <% end %>
      </div>
      <div class="col-md-6">
        <%= form_tag(coffeeshops_path, :method => "get", id: "search-form") do %>
          <div class="input-group ">
            <span class="input-group-btn">
              <button type="submit" class="btn btn-blue btn-default" type="button"><%= fa_icon "search" %></button>
            </span>
            <%= text_field_tag :search, params[:search], class: "form-control nudge", placeholder: "Search by name..." %>
          </div>
        <% end %>
      </div>
    </div>

    <h2><%= @coffeeshops.count %></h2>


    <% if @show_map %>
    <div id="map" style="height: 500px; width: 500px;">
      
    </div>
    <% end %>


  <% end %>

  <div class=" card-container text-center">
    <% @coffeeshops.each do |coffeeshop| %>
      <%= link_to coffeeshop_path(coffeeshop) do %>
        <div class="col-md-4">
          <div class="card-header">
            <%= image_tag coffeeshop.picture.url, class: 'card-image' if coffeeshop.picture? %>
            
          </div>
          <div class="card-title">
            <h3><%= truncate(coffeeshop.name, length: 20) %></h3>
          </div>
          <div class="card-body">
            <p><%= fa_icon "map-marker" %> <%= coffeeshop.city %></p>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% if @show_map %>
  <script>
    function initMap() {
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 8,
        center: {lat: 41.8369, lng: 87.6847}
      });
      <% i = 0 %>
      <% @coffeeshops.each do |coffeeshop| %>
      var infowindow<%= i %> = new google.maps.InfoWindow({
        content: "<%= coffeeshop.name %>"
      });
      var marker<%= i %> = new google.maps.Marker({
        position: {lat: <%= coffeeshop.latitude %>, lng: <%= coffeeshop.longitude %>},
        map: map,
        animation: google.maps.Animation.DROP,
        title: "<%= coffeeshop.name %>"
      })
      marker<%= i %>.addListener('click', function() {
        infowindow<%= i %>.open(map, marker<%= i %>);
      });
      <% i = i+1 %>
      <% end %>
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxb-nwbVf_TPsKG2BygPDyK8-AJUM_JtY&signed_in=true&callback=initMap"></script>
<% end %>
